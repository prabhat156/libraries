<!DOCTYPE html>
<meta charset="utf-8">

<link href="../src/nv.d3.css" rel="stylesheet" type="text/css">

<style>

body {
  overflow-y:scroll;
}

text {
  font: 12px sans-serif;
}

#chart1 {
  height: 500px;
  margin: 10px;
  min-width: 100px;
  min-height: 100px;
/*
  Minimum height and width is a good idea to prevent negative SVG dimensions...
  For example width should be =< margin.left + margin.right + 1,
  of course 1 pixel for the entire chart would not be very useful, BUT should not have errors
*/
}

</style>
<body>

  <div id="chart1" class='with-3d-shadow with-transitions'>
    <svg></svg>
  </div>
</body>

<script src="../lib/d3.v3.js"></script>
<script src="../nv.d3.js"></script>
<script src="../src/tooltip.js"></script>
<script src="../src/utils.js"></script>
<script src="../src/models/legend.js"></script>
<script src="../src/models/axis.js"></script>
<script src="../src/models/multiBar.js"></script>
<script src="../src/models/multiBarGroupChart.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="stream_layers.js"></script>
<script>

var test_data = stream_layers(3,10+Math.random()*100,.1).map(function(data, i) {
//var test_data = stream_layers(3,1,.1).map(function(data, i) { //for testing single data point
  return {
    key: 'Stream' + i,
    values: data
  };
});

//console.log('td',test_data);

var negative_test_data = new d3.range(0,3).map(function(d,i) { return {
  key: 'Stream' + i,
  values: new d3.range(0,3).map( function(f,j) {
      var xLabel;
      if(j==0) xLabel = "AMA";
      if(j==1) xLabel = "Amazing Race";
      if(j==2) xLabel = "CMA";
    return { 
             //y: Math.abs(10 + Math.random()*100 * (Math.floor(Math.random()*100)%2 ? 1 : -1)),
             y: Math.random()*100,
             //x: 'TTT'+j
             x: xLabel
           }
  })
  };  
});

var response1 = {"NFL-Pepsi": 10.05, "NFL-Cheerios": 60.09, "NFL-Peyton Manning": 80.02};
var response2 = {"AMA-Pepsi": 20.02, "AMA-Cheerios": 30.06, "AMA-Peyton Manning": 20.07};

var response = [response1, response2];

var keys1 = Object.keys(response1);
var keys2 = Object.keys(response2);

console.log(response1[1]);
var data = keys1.map(function(key, i){
                return {
                    key: key.split("-")[1],
                    values: [{x: key.split("-")[0], y: response1[key]}]
                }
            });

data.forEach(function(series, i){
    var key = keys2[i];
    series.values.push({x: key.split("-")[0], y: response2[key]});
});
console.log(data);

var urls = [
            "http://localhost:5600/twitter/brand_colocation/NFL?brand=Seahawks&brand=Cheerios&brand=Peyton%20Manning&relative=1",
            "http://localhost:5600/twitter/brand_colocation/Pepsi?brand=Seahawks&brand=Cheerios&brand=Peyton%20Manning&relative=1",
            "http://localhost:5600/twitter/brand_colocation/Denver%20Broncos?brand=Seahawks&brand=Cheerios&brand=Peyton%20Manning&relative=1"
            ];

var ajaxCounter = urls.length;
var ajaxResults = [];


$(document).ready(function(){

    // Fire of all the ajax requests
    for(var i=0; i<urls.length; i++){
        $.ajax({
            url: urls[i],
            dataType: "jsonp",
            success: function(response){
                ajaxResults.push(response);
                --ajaxCounter;

                if(ajaxCounter == 0){
                    // Do processing
                    var allKeys = ajaxResults.map(function(series){ return Object.keys(series)});
                    var data = allKeys[0].map(function(key, i){
                        return {
                            key: key.split("-")[1],
                            values: [{x: key.split("-")[0], y: ajaxResults[0][key]}]
                        }
                    });

                    for(var j=1; j<urls.length; j++){
                        data.forEach(function(series, i){
                            var key = allKeys[j][i];
                            series.values.push({x: key.split("-")[0], y: ajaxResults[j][key]});
                        });
                    }

                    console.log(data);
                    // Charting here
                    var chart;
                    nv.addGraph(function() {
                        chart = nv.models.multiBarChartNew()
                            // PK: Make sure that each series has its own color in different groups
                          //.barColor(d3.scale.category20().range())
                          .margin({bottom: 100})
                          .transitionDuration(300)
                          .delay(0)
                          // PK Dont rotate the labels
                          //.rotateLabels(45)
                          .groupSpacing(0.1)
                          ;
                    
                        chart.multibar
                          .hideable(true);
                    
                          // Avoid any staggering of the labels
                        //chart.reduceXTicks(false).staggerLabels(true);
                    
                        chart.xAxis
                            //.axisLabel("Current Index")
                            .showMaxMin(true)
                            //.tickFormat(d3.format(',.6f'))
                            ;
                    
                        chart.yAxis
                            .tickFormat(d3.format(',.1f'));
                    
                        chart.chartTitle("Brand Engagement");
                        chart.yAxisLabel("% of users shared with program");
                        chart.color([d3.scale.category20().range()[0], d3.scale.category20().range()[2], d3.scale.category20().range()[6]]);
                        // Disable controls as it will interfere with the yDomain because if you are stakced the domain might change
                        chart.showControls(false);
                        // Set y-domain to show 0-100% always
                        //chart.multibar.yDomain([0,100]);
                    
                        d3.select('#chart1 svg')
                            //.datum(negative_test_data)
                            .datum(data)
                           .call(chart);
                    
                        nv.utils.windowResize(chart.update);
                    
                        chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });
                    
                        return chart;
                    });

                }
            }
        });
    }

    //GOLD//$.ajax({
    //GOLD//    url: "http://localhost:5600/twitter/brand_colocation/NFL?brand=Seahawks&brand=Cheerios&brand=Peyton%20Manning&relative=1",
    //GOLD//    dataType: "jsonp",
    //GOLD//    success: function(response){
    //GOLD//        console.log(response);
    //GOLD//        var data1 = response;
    //GOLD//        var keys1 = Object.keys(data1);
    //GOLD//        $.ajax({
    //GOLD//            url: "http://localhost:5600/twitter/brand_colocation/Pepsi?brand=Seahawks&brand=Cheerios&brand=Peyton%20Manning&relative=1",
    //GOLD//            dataType: "jsonp",
    //GOLD//            success: function(response){
    //GOLD//                var data2 = response;
    //GOLD//                var keys2 = Object.keys(data2);

    //GOLD//                var data = keys1.map(function(key, i){
    //GOLD//                    return {
    //GOLD//                        key: key.split("-")[1],
    //GOLD//                        values : [{x: key.split("-")[0], y: 100*data1[key]}]
    //GOLD//                    }
    //GOLD//                });

    //GOLD//                data.forEach(function(series, i){
    //GOLD//                    var key = keys2[i];
    //GOLD//                    series.values.push({x: key.split("-")[0], y: 100*data2[key]});
    //GOLD//                });

    //GOLD//                console.log(data);
    //GOLD//                // Charting here
    //GOLD//                var chart;
    //GOLD//                nv.addGraph(function() {
    //GOLD//                    chart = nv.models.multiBarChartNew()
    //GOLD//                        // PK: Make sure that each series has its own color in different groups
    //GOLD//                      //.barColor(d3.scale.category20().range())
    //GOLD//                      .margin({bottom: 100})
    //GOLD//                      .transitionDuration(300)
    //GOLD//                      .delay(0)
    //GOLD//                      // PK Dont rotate the labels
    //GOLD//                      //.rotateLabels(45)
    //GOLD//                      .groupSpacing(0.1)
    //GOLD//                      ;
    //GOLD//                
    //GOLD//                    chart.multibar
    //GOLD//                      .hideable(true);
    //GOLD//                
    //GOLD//                      // Avoid any staggering of the labels
    //GOLD//                    //chart.reduceXTicks(false).staggerLabels(true);
    //GOLD//                
    //GOLD//                    chart.xAxis
    //GOLD//                        //.axisLabel("Current Index")
    //GOLD//                        .showMaxMin(true)
    //GOLD//                        //.tickFormat(d3.format(',.6f'))
    //GOLD//                        ;
    //GOLD//                
    //GOLD//                    chart.yAxis
    //GOLD//                        .tickFormat(d3.format(',.1f'));
    //GOLD//                
    //GOLD//                    chart.chartTitle("Brand Engagement");
    //GOLD//                    chart.yAxisLabel("% of users shared with program");
    //GOLD//                    chart.color([d3.scale.category20().range()[0], d3.scale.category20().range()[2], d3.scale.category20().range()[6]]);
    //GOLD//                    // Disable controls as it will interfere with the yDomain because if you are stakced the domain might change
    //GOLD//                    chart.showControls(false);
    //GOLD//                    // Set y-domain to show 0-100% always
    //GOLD//                    //chart.multibar.yDomain([0,100]);
    //GOLD//                
    //GOLD//                    d3.select('#chart1 svg')
    //GOLD//                        //.datum(negative_test_data)
    //GOLD//                        .datum(data)
    //GOLD//                       .call(chart);
    //GOLD//                
    //GOLD//                    nv.utils.windowResize(chart.update);
    //GOLD//                
    //GOLD//                    chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });
    //GOLD//                
    //GOLD//                    return chart;
    //GOLD//                });
    //GOLD//            }
    //GOLD//        });
    //GOLD//    }
    //GOLD//});
});

console.log(negative_test_data);





</script>
